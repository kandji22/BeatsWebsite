{% extends 'base.html.twig' %}

{% block title %}Home{% endblock %}
 {% block stylesheets %}
     {{ parent() }}
     <style>
         .music-player {
             margin-bottom: 2rem;
         }
     </style>
{% endblock %}
{% block head %}
    {{ parent() }}
    <article class="screen">
        <input type="checkbox" value="None" id="magicButton" name="check" />
        <label class="main" for="magicButton"></label>

        <div class="coverImage"></div>
        <div class="search"></div>
        <div class="bodyPlayer"></div>

        <table class="list">
            <tr class="song" data-song="http://jplayer.org/audio/m4a/Miaow-07-Bubble.m4a" data-piste="1">
                <td class="nr">
                    <h5>1<h5></td>
                <td class="title"><h6>Heavydirtysoul<h6></td>
                <td class="length"><h5>3:54<h5></td>
                <td><input type="checkbox" id="heart"/><label class="zmr" for="heart"></label></td>
            </tr>

            <tr class="song" data-song="https://www.jplayer.org/audio/mp3/TSP-01-Cro_magnon_man.mp3" data-piste="2">
                <td class="nr"><h5>2<h5></td>
                <td class="title"><h6 style="color: #ff564c;">StressedOut<h6></td>
                <td class="length"><h5>3:22<h5></td>
                <td><input type="checkbox" id="heart1" checked /><label class="zmr" for="heart1"></label></td>
            </tr>

        </table>

        <div class="shadow"></div>

        <div class="bar"></div>

        <div class="info">
            <h4>STRESSED OUT</h4>
            <h3>twenty one pilots - Blurryface</h3>
            <!-- ici mettre une condition pour dire que le produit est déjâ ajouter au panier -->
            <i class="fa fa-cart-arrow-down panier_show" aria-hidden="true" style='font-size:24px; display:none'></i>
            <div class="show_card" style ="display: none; margin-top: 6px; "> <a href="{{ path('app_show_card') }}" class="btn btn-primary" style="font-size: 11px" > Voir mon panier <i class="fa fa-arrow-right"></i> </a></div>
        </div>
        <audio preload="auto" id="audio" controls>
            <source src="http://www.jplayer.org/audio/mp3/Miaow-02-Hidden.mp3">
        </audio>


        <div class="music-player" style = "display: none">
            <div class="progress-wrapper">
                <div class="progress-bar"></div>
            </div>
        </div>
        <table class="player">
            <td><input type="checkbox" id="backward"/><label class="backward" for="backward"></label></td>
            --<td><input type="checkbox" id="play" title="Play"/><label class="play" for="play"></label></td>
            <td><input type="checkbox" id="forward"/><label class="forward" for="forward"></label></td>
        </table>

        <table class="footer">
            <td><input type="checkbox" id="love" checked /><label class="love" for="love"></label></td>
            <td><input type="checkbox" id="shuffle"/><label class="shuffle" for="shuffle"></label></td>
            <td><input type="checkbox" id="repeat" checked /><label class="repeat" for="repeat"></label></td>
            <td><input type="checkbox" id="options"/><label class="options" for="options"></label></td>
        </table>

        <div class="current"><h2>STRESSED OUT</h2></div>


    </article>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script
            src="https://code.jquery.com/jquery-3.6.4.js"
            integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E="
            crossorigin="anonymous"
    ></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.0/gsap.min.js"
            integrity="sha512-2fk3Q4NXPYAqIha0glLZ2nluueK43aNoxvijPf53+DgL7UW9mkN+uXc1aEmnZdkkZVvtJZltpRt+JqTWc3TS3Q=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    ></script>
    <script>
        $(function(){
            var progressBar = $('.progress-bar');
            var audioPlayer;
            var progressWrapper = $('.progress-wrapper');
            $(".song").on("click", function () {
                $(".song").removeClass("active");
                $(this).addClass("active");
            });
            let toggle = document.querySelector(".toggle");
            let body = document.querySelector("body");

            let tl = gsap.timeline();

            toggle.addEventListener("click", function () {
                if (body.classList.contains("open")) {
                    //Fermer le menu.
                    body.classList.remove("open");
                    tl.to(".sep", {
                        duration: 0,
                        height: 0,
                    });

                    tl.to(".sep__icon", {
                        duration: 0,
                        opacity: 0,
                    });
                } else {
                    //Ouvrir le menu.
                    body.classList.add("open");

                    tl.to(".sep", {
                        duration: 0.75,
                        height: "100%",
                        delay: 0.5,
                    });

                    tl.to(".sep__icon", {
                        opacity: 1,
                        duration: 0.25,
                        delay: -0.5,
                    });

                    tl.from(
                        ".menu__left__inner__item",
                        {
                            y: 40,
                            opacity: 0,
                            stagger: 0.25,
                        },
                        "<-0.5"
                    );

                    tl.from(
                        ".menu__right__inner__item",
                        {
                            y: 40,
                            opacity: 0,
                            stagger: 0.25,
                        },
                        "<0.5"
                    );
                }
            });


            var audio = document.getElementById('audio');
            var playpause = document.getElementById("play");
            var duration;
            var tabSound = {}
            var indexSound = 1
            $('.song').each(function(){

                tabSound[$(this).data('piste')] = $(this).data('song')
            })
            $.each(tabSound,function (key,val){
                if(val == undefined) {
                    tabSound.splice(key,1)
                }
            })

            function togglePlayPause() {
                if (audio.paused || audio.ended) {
                    playpause.title = "Pause";
                    audio.play();
                } else {
                    playpause.title = "Play";
                    audio.pause();
                }
            }
            $('#magicButton').on('click',function (){
                $('.panier_show').toggle()
            })
            $('#play').on('click',function() {
                togglePlayPause()
            })
            $('.song').on('click',function(){
                progressBar.width(0 + '%');
                indexSound = $(this).data('piste')
                goTo(tabSound[indexSound])
            })
            $('.panier_show').on('click',function () {
                $(this).hide('slow')
                $('.show_card').show('slow')
            })
        $('#forward').on('click',function () {
            indexSound++
            if(tabSound.hasOwnProperty(indexSound)) {
                goTo(tabSound[indexSound])
            }
            else {
                indexSound--
            }
        })
        $('#backward').on('click',function () {
            indexSound--
            if(tabSound.hasOwnProperty(indexSound)) {
                goTo(tabSound[indexSound])
            }
            else {
                indexSound++
            }
        })

            function goTo(piste = null) {

                $("#audio source").prop("src", piste);
                $("#audio")[0].load();
                $("#audio")[0].play();
                $('#play').prop('checked',true)
            }
            $('#magicButton').on('click',function(){
                $('.music-player').toggle()
            })

            // Mise à jour de la barre de progression et du temps de lecture
            function updateProgress() {
                currentTime = audio.currentTime;
                duration = audio.duration;
                if (!isNaN(duration)) {
                    var percent = currentTime / duration * 100;
                    progressBar.width(percent + '%');
                }
                if(currentTime == duration) {
                    indexSound++
                    pause()
                    if( tabSound.hasOwnProperty(indexSound)) {
                        goTo(tabSound[indexSound])
                    }
                    else {
                        numeroAudio--
                        audio.pause()
                    }

                }
            }
            // Mettre à jour la barre de progression et le temps de lecture toutes les 500 millisecondes
            setInterval(updateProgress, 500);

            // Déplacer la barre de progression au clic sur progress-wrapper si une chanson est sélectionnée
            progressWrapper.on('click', function (e) {

                if (isSongSelected() && !isNaN(duration)) {
                    var pos = (e.pageX - $(this).offset().left) / $(this).width();
                    audio.currentTime = pos * duration;
                    updateProgress();
                }
            });
            // Vérifier si une chanson est sélectionnée
            function isSongSelected() {
                return $('source').src !== "";
            }
        })

    </script>
{% endblock %}



